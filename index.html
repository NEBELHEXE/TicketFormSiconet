<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Siconet Ticket Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="ticketsiconet.css" />

  <script>
    // Función para generar un ID único
    function generarId() {
      return 'ID-' + Math.random().toString(36).substr(2, 9);
    }

    window.onload = function () {
      const idElemento = document.getElementById('id');
      if (idElemento) {
        idElemento.value = generarId();
        idElemento.readOnly = true;
      }

      const form = document.getElementById("survey-form");
      if (form) {
        form.addEventListener("submit", function(event){
          event.preventDefault(); // evita envío tradicional

          const formData = new FormData(form);

          // 1️⃣ Enviar PDF vía Apps Script
          google.script.run.withSuccessHandler(function(msg){
            // alerta de PDF enviado
            alert(msg); 

            // 2️⃣ Enviar datos al Google Form
            fetch(form.action, {
              method: 'POST',
              mode: 'no-cors', // necesario para Google Forms
              body: formData
            }).then(() => {
              // limpiar formulario
              form.reset();
              if (idElemento) {
                idElemento.value = generarId(); // regenerar ID
              }
            }).catch((err) => {
              console.error("Error enviando a Google Form:", err);
            });

          }).enviarTablaPDF();
        });
      }
    };
  </script>
</head>

<body>
 <div class="header">
  <a href="https://ticketsiconet.netlify.app/">
    <img src="https://siconet.com.mx/wp-content/uploads/2016/12/transparente_2-01.png" alt="siconet-logo" />
  </a>
</div>

  <h1 id="title">Ticket Form</h1>
  <p id="description">Por favor, llena todos los campos.</p>

  <form id="survey-form" 
        action="https://docs.google.com/forms/d/e/1FAIpQLSeauWSOeMt7cyNZMzFfVCBGV7tCSnAlAr1XyDwiUIg52MJuWQ/formResponse" 
        method="POST">

    <label id="empresa-label">Empresa:</label>
    <input id="empresa" name="entry.1762862587" required type="text" placeholder="Siconet..."><br />

    <label id="fecha-label">Fecha:</label>
    <input id="fecha" name="entry.633378028" required type="date"><br />

    <label id="id-label">ID:</label>
    <input id="id" name="entry.472985924" required type="text" readonly><br />

    <label id="urgencia-label">Nivel de Urgencia:</label><br />
    <select id="urgencia" name="entry.923568759" required>
      <option value="">Selecciona una opción</option>
      <option>1. Menor</option>
      <option>2. Medio</option>
      <option>3. Alto</option>
    </select>
    <hr />

    <label>Descripción del problema:</label><br />
    <textarea name="entry.95601876" rows="3" cols="50"></textarea>
    <hr />

    <input id="submit" type="submit" value="Enviar Ticket">
  </form>
</body>
</html>
